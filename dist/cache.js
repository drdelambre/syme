"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),_storageController=require("./internal/storage-controller"),_storageController2=_interopRequireDefault(_storageController),_observer=require("./internal/observer"),_observer2=_interopRequireDefault(_observer),_uuid=require("./internal/uuid"),_uuid2=_interopRequireDefault(_uuid);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Cache=function(){function r(e){_classCallCheck(this,r);var t=e||{};if(this.key=t.key||this.constructor.name,this.channel=t.channel||"memory",this.expiration=parseInt(t.expiration||500,10),this.controller=_storageController2.default,!/^(memory|local|session)$/.test(this.channel))throw new Error(["Invalid storage mechanism sent","to "+this.constructor.name+".channel"].join(" "));if("undefined"==typeof window&&(this.channel="memory"),isNaN(this.expiration))throw new Error(["Invalid expiration time set for",this.constructor.name+".expiration"].join(" "));t.model&&(this.model=t.model),Object.defineProperty(this,"cached",{get:function(){var r=this,n=this.controller.freshness(this.channel,this.key);return this.controller.get(this.channel,this.key).then(function(e){if(!n&&Object.keys(e).length||n&&Date.now()-n<r.expiration){if(r.model){var t=new r.model;return t.fill(e),t}return e}return n&&r.controller.remove(r.channel,r.key,!1),!1})},set:function(){throw new Error("cached is a read only property")}})}return _createClass(r,[{key:"populate",value:function(e){var t=e,r=this.model;return this.model&&("[object Array]"===Object.prototype.toString.call(this.model)&&(r=this.model[0]),"[object Array]"===Object.prototype.toString.call(e)?t=e.map(function(e){return e instanceof r?e.out():e}):e instanceof r&&(t=e.out())),this.controller.populate(this.channel,this.key,this.expiration,t),this}},{key:"clear",value:function(){return this.controller.remove(this.channel,this.key),this}},{key:"watch",value:function(n){var o=this;return this.controller.register(this.channel,this.key,function(e){var t=o.model,r=e;o.model&&("[object Array]"===Object.prototype.toString.call(o.model)&&(t=o.model[0]),r="[object Array]"===Object.prototype.toString.call(e)?e.map(function(e){return new t(e)}):new t(e)),n(r)})}},{key:"registerWorker",value:function(e){var n,t,i=this,r=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],a=r?e.port:e,l=new _observer2.default,s={populate:function(e,t,r,n){a.postMessage({action:"update",payload:{channel:e,key:t,expiration:r,data:n}})},get:function(e,o){return new Promise(function(t){var r=(0,_uuid2.default)(),n=l(function(e){e.payload.uuid===r&&(t(e.payload.data),n.remove())});a.postMessage({action:"query",payload:{channel:e,key:o,uuid:r}})})},freshness:function(e,t){return s._exp},remove:function(e,t,r){delete s._exp,a.postMessage({action:"remove",payload:{channel:e,key:t,shouldUpdate:r}})},register:(n=new _observer2.default,t=function(e,t,r){return n(r)},t.fire=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];n.fire.apply(n,t)},t)};a.addEventListener("message",function(e){if("query"!==e.data.action){if("update"===e.data.action){var t=e.data.payload,r=t.channel,n=t.key,o=t.expiration,a=t.data;r===i.channel&&n===i.key&&(s._exp=o,s.register.fire(a))}}else l.fire(e.data)}),r&&a.postMessage({action:"register",payload:{channel:this.channel,key:this.key}}),this.controller=s}}]),r}();exports.default=Cache;