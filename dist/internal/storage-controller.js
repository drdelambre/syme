"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.StorageController=void 0;var _createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}(),_storage=require("./storage"),_storage2=_interopRequireDefault(_storage);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function normalizeChannel(e,t){if(!/^(memory|local|session)$/.test(e))throw new Error("Invalid storage mechanism sent to StorageController."+t);return"undefined"==typeof window?"memory":e}var StorageController=function(){function e(){var n=this;if(_classCallCheck(this,e),"undefined"!=typeof window&&window.StorageController)try{var a=JSON.parse(window.atob(window.StorageController));if("[object Object]"!==Object.prototype.toString.call(a))throw new Error("invalid type");setImmediate(this._pruneCache.bind(this,function(){var e=a.memory||{},t=a.local||{},r=a.session||{},o=void 0;for(o in e)n.populate("memory",o,0,e[o],!0);for(o in t)n.populate("local",o,0,t[o],!0);for(o in r)n.populate("session",o,0,r[o],!0)}))}catch(e){throw new Error("Invalid string passed through window.StorageController")}}return _createClass(e,[{key:"_pruneCache",value:function(e){var t=Date.now(),r=_storage2.default.memory.get("fresh")||{},o=_storage2.default.local.get("fresh")||{},n=_storage2.default.session.get("fresh")||{},a=void 0;for(a in r)("[object Object]"!==Object.prototype.toString.call(r[a])||r[a].expires<t)&&this.remove("memory",a,!1);for(a in o)("[object Object]"!==Object.prototype.toString.call(o[a])||o[a].expires<t)&&this.remove("local",a,!1);for(a in n)("[object Object]"!==Object.prototype.toString.call(n[a])||n[a].expires<t)&&this.remove("session",a,!1);e()}},{key:"register",value:function(e,t,r){var o=this,n=_storage2.default.memory.get("events")||{};if(normalizeChannel(e,"register"),"function"==typeof r)return n.hasOwnProperty(t)||(n[t]=[]),n[t].push(r),_storage2.default.memory.set("events",n),{remove:function(){o._unregister(e,t,r)}}}},{key:"_unregister",value:function(e,t,r){var o=_storage2.default.memory.get("events")||{};if(normalizeChannel(e,"unregister"),!o.hasOwnProperty(t))throw new Error("Cannot unregister an unregistered event");o[t]=o[t].filter(function(e){return e!==r}),_storage2.default.memory.set("events",o)}},{key:"populate",value:function(e,t,r,o){var n=4<arguments.length&&void 0!==arguments[4]&&arguments[4],a=normalizeChannel(e,"populate"),s=_storage2.default.memory.get("events")||{},l=_storage2.default[a].get("fresh")||{},i=JSON.stringify(o),u=void 0;if(n?l.hasOwnProperty(t)||(l[t]={}):!r&&l[t]&&"[object Object]"===Object.prototype.toString.call(l[t])?l[t]={hit:Date.now(),expires:Date.now()+(l[t].expires-l[t].hit)}:l[t]={hit:Date.now(),expires:Date.now()+r},_storage2.default[a].set(t,i),_storage2.default[a].set("fresh",l),s.hasOwnProperty(t))for(u=0;u<s[t].length;u++)s[t][u](JSON.parse(i))}},{key:"remove",value:function(e,t){var r=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],o=normalizeChannel(e,"remove"),n=_storage2.default.memory.get("events")||{},a=_storage2.default[o].get("fresh")||{},s=void 0;if(delete a[t],_storage2.default[o].set(t,"{}"),_storage2.default[o].set("fresh",a),r&&n.hasOwnProperty(t))for(s=0;s<n[t].length;s++)n[t][s](!1)}},{key:"get",value:function(e,t){var r=normalizeChannel(e,"get"),o=_storage2.default[r].get(t)||"{}";return new Promise(function(e){e(JSON.parse(o))})}},{key:"freshness",value:function(e,t){var r=normalizeChannel(e,"freshness"),o=_storage2.default[r].get("fresh")||{};return o.hasOwnProperty(t)?"[object Object]"!==Object.prototype.toString.call(o[t])?(this.remove(e,t,!1),0):o[t].hit:0}},{key:"_out",value:function(){var t={memory:{},local:{},session:{}};return Object.keys(_storage2.default.memory.get("fresh")||{}).forEach(function(e){t.memory[e]=JSON.parse(_storage2.default.memory.get(e))}),Object.keys(_storage2.default.local.get("fresh")||{}).map(function(e){t.local[e]=JSON.parse(_storage2.default.local.get(e))}),Object.keys(_storage2.default.session.get("fresh")||{}).map(function(e){t.session[e]=JSON.parse(_storage2.default.session.get(e))}),JSON.stringify(t)}},{key:"out",value:function(){return'window.StorageController = "'+new Buffer(this._out()).toString("base64")+'";'}}]),e}(),outer=new StorageController;"undefined"!=typeof window&&(window.StorageController=outer),exports.StorageController=StorageController,exports.default=outer;